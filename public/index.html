<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual ED Cases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* ... all your existing CSS unchanged ... */
  </style>
</head>
<body>
  <!-- ... all your existing HTML unchanged ... -->

  <script>
    // Serve Master_Excel.csv as a static file from /public
    // Make sure you copy the CSV into the public/ folder in your image.
    const CSV_URL = "/Master_Excel.csv";

    const state = {
      seriesMap: {},    // id -> { id, introVideoUrl, cases: [...] }
      currentId: null,
      currentCaseIndex: null,
      currentStep: 0,   // 0 history, 1 exam, 2 investigations, 3 management, 4 questions, 5 debrief
      chatMessages: []
    };

    function slugify(str) {
      return (str || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_");
    }

    function buildSeries(rows) {
      const seriesMap = {};

      rows.forEach(row => {
        const id = (row["ID"] || "").trim();
        if (!id) return;

        if (!seriesMap[id]) {
          const idSlug = slugify(id);
          seriesMap[id] = {
            id,
            introVideoUrl: `https://storage.googleapis.com/virtualed-466321_cloudbuild/debrief_videos/${idSlug}.mp4`,
            cases: []
          };
        }

        const diseaseName = (row["Disease_name"] || "").trim();
        const diseaseSlug = slugify(diseaseName);

        const patientNameRaw = row["Patient_name"] || "";
        const patientParts = patientNameRaw.split("@");
        const patientName = (patientParts[1] || patientParts[0] || "").trim();

        const caseObj = {
          id,
          diseaseName,
          patientName,
          historyText: row["History_text"] || "",
          examText: row["Examination_text"] || "",
          invText: row["Investigations_text"] || "",
          managementText: row["Management_text"] || "",
          mcqQuestion: row["MCQ_question_1"] || "",
          mcqOptions: {
            A: row["MCQ_question_1_A"] || "",
            B: row["MCQ_question_1_B"] || "",
            C: row["MCQ_question_1_C"] || "",
            D: row["MCQ_question_1_D"] || ""
          },
          sa1Question: row["SA_question_1"] || "",
          sa1Answer: row["SA_answer_1"] || "",
          sa2Question: row["SA_question_2"] || "",
          sa2Answer: row["SA_answer_2"] || "",
          historyVideoUrl: `https://storage.googleapis.com/virtualed-466321_cloudbuild/videos/${diseaseSlug}.MOV`,
          debriefVideoUrl: `https://storage.googleapis.com/virtualed-466321_cloudbuild/debrief_videos2/${diseaseSlug}.mp4`,
          imageUrl: `https://storage.googleapis.com/virtualed-466321_cloudbuild/images/${diseaseSlug}.jpeg`
        };

        seriesMap[id].cases.push(caseObj);
      });

      return seriesMap;
    }

    // ... renderIdList, renderCaseList, renderCaseViewer, etc. all unchanged ...

    // --- Chat / AI history ---
    function setupChat() {
      const messagesEl = document.getElementById("chat-messages");
      const textarea = document.getElementById("chat-textarea");
      const sendBtn = document.getElementById("chat-send");

      if (!messagesEl || !textarea || !sendBtn) return;

      function renderMessages() {
        messagesEl.innerHTML = "";
        state.chatMessages.forEach(m => {
          const div = document.createElement("div");
          div.className = "chat-message " + (m.role === "user" ? "user" : "assistant");
          div.textContent = m.content;
          messagesEl.appendChild(div);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      sendBtn.onclick = async () => {
        const text = textarea.value.trim();
        if (!text) return;
        textarea.value = "";

        state.chatMessages.push({ role: "user", content: text });
        renderMessages();

        sendBtn.disabled = true;
        const originalLabel = sendBtn.textContent;
        sendBtn.textContent = "â€¦";

        // Simple fetch timeout so UI doesn't hang forever
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 25000); // 25s

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: state.chatMessages }),
            signal: controller.signal
          });

          if (!response.ok) {
            throw new Error("Chat request failed with status " + response.status);
          }

          const data = await response.json();
          const reply = data.reply || "Sorry, I couldn't generate a response.";
          state.chatMessages.push({ role: "assistant", content: reply });
        } catch (err) {
          state.chatMessages.push({
            role: "assistant",
            content:
              "There was a problem contacting the AI history service. Please try again later."
          });
          console.error("Chat error:", err);
        } finally {
          clearTimeout(timeoutId);
          sendBtn.disabled = false;
          sendBtn.textContent = originalLabel;
          renderMessages();
        }
      };

      if (!state.chatMessages.length) {
        state.chatMessages.push({
          role: "assistant",
          content: "I'm the patient. Ask me about my symptoms, history and concerns."
        });
      }

      renderMessages();
    }

    // --- Initial CSV load ---
    async function loadCsv() {
      try {
        console.log("Fetching CSV from:", CSV_URL);
        const res = await fetch(CSV_URL);
        console.log("CSV HTTP status:", res.status);

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const text = await res.text();
        console.log("First 200 chars of CSV:", text.slice(0, 200));

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true
        });

        console.log("Parsed headers:", Object.keys(parsed.data[0] || {}));
        state.seriesMap = buildSeries(parsed.data);
        console.log("Series IDs found:", Object.keys(state.seriesMap));
        renderIdList();
      } catch (err) {
        console.error("CSV load error:", err);
        document.getElementById("id-list").textContent =
          "Error loading CSV: " + err.message;
      }
    }

    document.addEventListener("DOMContentLoaded", loadCsv);
  </script>
</body>
</html>
